<div class="comment-container info collapsed" tabindex="0" *ngIf="collapsed">
  <span class="comment-expand fake-link" (click)="store.local.setRefToggled(ref.url, collapsed = false)">[+]</span>&nbsp;
  <ng-container *ngFor="let user of authors">
    <a class="author" [routerLink]="['/tag', user]">
      {{ formatAuthor(user) }}
    </a>
  </ng-container>
  <span class="lock icon" *ngIf="locked" title="Locked">🔒️</span>
  <span [title]="ref.created?.toISOString()">{{ ref.created?.fromNow() }}</span>
  <span *ngIf="!ref.modified?.isSame(ref.created)" [title]="ref.modified?.fromNow()">*</span>
  {{ comments }}
</div>

<div class="comment-container info collapsed" tabindex="0" *ngIf="ref.plugins?.['plugin/comment']?.deleted">
  deleted comment
</div>

<div class="comment-container" tabindex="0" *ngIf="!collapsed && !ref.plugins?.['plugin/comment']?.deleted">
  <div class="info">
    <span class="comment-collapse fake-link" (click)="store.local.setRefToggled(ref.url, collapsed = true)">[&ndash;]</span>&nbsp;
    <ng-container *ngFor="let user of authors">
      <a class="author" [routerLink]="['/tag', user]">
        {{ formatAuthor(user) }}
      </a>
    </ng-container>
    <span [title]="ref.created?.toISOString()">{{ ref.created?.fromNow() }}</span>
    <span *ngIf="!ref.modified?.isSame(ref.created)" [title]="'last edited ' + ref.modified?.fromNow()">*</span>
    <ng-container *ngIf="tagged.length">
      tagged
      <ng-container *ngFor="let tag of tagged">
        <a class="tag" [routerLink]="['/tag', tag]">{{ tag }}</a>&nbsp;
      </ng-container>
    </ng-container>
  </div>
  <app-md *ngIf="!editing"
          class="comment-body"
          [origin]="ref.origin"
          [plugins]="ref.tags"
          [text]="ref.comment || ''"></app-md>
  <app-comment-edit *ngIf="editing"
                    [ref]="ref"
                    [commentEdited$]="commentEdited$"></app-comment-edit>
  <div class="actions">
    <a [routerLink]="['/ref', ref.url, 'comments']" [queryParams]="{ origin }">permalink</a>
    <a [routerLink]="['/ref', ref.url, 'responses']" [queryParams]="{ origin }">{{ responses.replace(' ', '&thinsp;') }}</a>
    <a *ngIf="sources === 'parent'" [routerLink]="['/ref', ref.sources![0]]" [queryParams]="{ origin }">parent</a>
    <a *ngIf="sources !== 'parent'" [routerLink]="['/ref', ref.url, 'sources']" [queryParams]="{ origin }">{{ sources.replace(' ', '&thinsp;')}}</a>
    <ng-container *ngIf="admin.status.plugins.graph">
      <a [routerLink]="['/ref', ref.url, 'graph']" [queryParams]="{ origin }">graph</a>
    </ng-container>
    <a class="fake-link"
       *ngIf="writeAccess"
       (click)="editing = !editing">edit</a>
    <a class="fake-link"
       *ngIf="!deleting && writeAccess"
       (click)="deleting = true">delete</a>
    <span *ngIf="deleting" class="delete-confirm"> are you sure?
      <a class="fake-link" (click)="delete()">yes</a> /
      <a class="fake-link" (click)="deleting = false">no</a>
    </span>
    <a class="fake-link"
       *ngIf="!ref.origin && store.account.editor || writeAccess"
       (click)="tagging = !tagging">tag</a>
    <span *ngIf="tagging" class="inline-tagging">
      <input #inlineTag
             (keydown)="$event.key === 'Enter' && addInlineTag() || true"
             type="text"
             inputmode="email"
             [pattern]="tagRegex"
             autocorrect="off"
             autocapitalize="none"
             appAutofocus>
      <button (click)="addInlineTag()">+</button>
    </span>
    <a class="fake-link"
       (click)="replying = !replying">reply</a>
    <ng-container *ngIf="canInvoice">
      <a [routerLink]="['/submit/invoice']"
         [queryParams]="{ url: ref.url }">invoice</a>
    </ng-container>
    <a *ngIf="store.account.mod && !approved"
       class="fake-link"
       (click)="approve()">approve</a>
    <span class="approved icon" *ngIf="store.account.mod && approved">✔️</span>
  </div>
</div>
<app-comment-reply *ngIf="replying"
                   [autofocus]="true"
                   [to]="ref"
                   [showCancel]="true"
                   [tags]="mailboxes"
                   [newComments$]="newComments$"></app-comment-reply>
<span class="fake-link load-more"
      *ngIf="!collapsed && context < maxContext && depth === 0 && ref.metadata!.plugins?.['plugin/comment']"
      (click)="depth = depth + 1">
  load more comments
</span>
<a class="load-more"
   *ngIf="!collapsed && context >= maxContext && depth === 0 && ref.metadata!.plugins?.['plugin/comment']"
   [routerLink]="['/ref', ref.url, 'comments']" [queryParams]="{ origin }">
  continue this thread
</a>
<div *ngIf="depth! > 0"
     class="comment-children"
     [class.hidden-without-removing]="collapsed">
  <app-comment-list [top]="top"
                    [source]="ref.url"
                    [depth]="depth! - 1"
                    [context]="context + 1"
                    [newComments$]="newComments$"></app-comment-list>
</div>

<ng-container *ngFor="let e of serverError">
  <div class="error">{{ e }}</div>
</ng-container>

<div class="comment-container info collapsed" tabindex="0" *ngIf="collapsed">
  <span class="comment-expand fake-link" (click)="collapsed = false">[+]</span>&nbsp;
  <ng-container *ngFor="let user of authors">
    <a class="author" [routerLink]="['/tag', user]">{{ user.replace('user/', '') + ref.origin }}</a>
  </ng-container>
  {{ ref.created?.fromNow() }}
  {{ comments }}
</div>

<div class="comment-container info collapsed" tabindex="0" *ngIf="ref.plugins?.['plugin/comment']?.deleted">
  deleted comment
</div>

<div class="comment-container" tabindex="0" *ngIf="!collapsed && !ref.plugins?.['plugin/comment']?.deleted">
  <div class="info">
    <span class="comment-collapse fake-link" (click)="collapsed = true">[&ndash;]</span>&nbsp;
    <ng-container *ngFor="let user of authors">
      <a class="author" [routerLink]="['/tag', user]">{{ user.replace('user/', '') + ref.origin }}</a>
    </ng-container>
    {{ ref.created?.fromNow() }}
    <ng-container *ngIf="tags.length">
      tagged
      <ng-container *ngFor="let tag of tags">
        <a class="tag" [routerLink]="['/tag', tag]">{{ tag }}</a>&nbsp;
      </ng-container>
    </ng-container>
  </div>
  <div *ngIf="!editing"
       class="md comment-body"
       markdown emoji katex
       [katexOptions]="{ throwOnError: false }"
       [data]="ref.comment"></div>
  <app-comment-edit *ngIf="editing"
                    [ref]="ref"
                    [commentEdited$]="commentEdited$"></app-comment-edit>
  <div class="actions">
    <a [routerLink]="['/ref/comments/', ref.url]">permalink</a>
    <a [routerLink]="['/ref/responses/', ref.url]">{{ responses.replace(' ', '&thinsp;') }}</a>
    <a [routerLink]="['/ref/sources/', ref.url]">{{ sources.replace(' ', '&thinsp;')}}</a>
    <a [routerLink]="['/ref/graph/', ref.url]">graph</a>
    <a class="fake-link" *ngIf="writeAccess$ | async" (click)="editing = !editing">edit</a>
    <a class="fake-link" *ngIf="!deleting && (writeAccess$ | async)" (click)="deleting = true">delete</a>
    <span *ngIf="deleting" class="delete-confirm">
      are you sure?
      <a class="fake-link" (click)="delete()">yes</a>
      /
      <a class="fake-link" (click)="deleting = false">no</a>
    </span>
    <a class="fake-link" *ngIf="writeAccess$ | async" (click)="tagging = !tagging">tag</a>
    <span *ngIf="tagging" class="inline-tagging">
      <input #inlineTag
             (keydown)="$event.key === 'Enter' && addInlineTag() || true"
             type="text"
             pattern="_?[a-z]+(/[a-z]+)*"
             appAutofocus>
      <button (click)="addInlineTag()">+</button>
    </span>
    <a class="fake-link" (click)="replying = !replying">reply</a>
  </div>
</div>
<app-comment-reply *ngIf="replying"
                   [top]="top"
                   [showCancel]="true"
                   [sources]="[ref.url]"
                   [tags]="inboxes"
                   [newComments$]="newComments$"></app-comment-reply>
<span class="fake-link load-more"
      *ngIf="!collapsed && depth === 0 && ref.metadata!.comments.length > 0"
      (click)="depth = depth + 1">
  load more comments
</span>
<div *ngIf="depth! > 0"
     class="comment-children"
     [class.hidden-without-removing]="collapsed">
  <app-comment-list [top]="top"
                    [source$]="source$"
                    [depth]="depth! - 1"
                    [newComments$]="newComments$"></app-comment-list>
</div>

<div class="comment-container info collapsed" tabindex="0" *ngIf="collapsed">
  <span class="comment-expand fake-link" (click)="collapsed = false">[+]</span>&nbsp;
  <ng-container *ngFor="let user of authors">
    <a class="author" [routerLink]="['/tag', user]">
      {{ user.replace('+', '').replace('user/', '') }}
    </a>
  </ng-container>
  <span class="lock icon" *ngIf="locked" title="Locked">🔒️</span>
  <span [title]="ref.created?.toISOString()">{{ ref.created?.fromNow() }}</span>
  {{ comments }}
</div>

<div class="comment-container info collapsed" tabindex="0" *ngIf="ref.plugins?.['plugin/comment']?.deleted">
  deleted comment
</div>

<div class="comment-container" tabindex="0" *ngIf="!collapsed && !ref.plugins?.['plugin/comment']?.deleted">
  <div class="info">
    <span class="comment-collapse fake-link" (click)="collapsed = true">[&ndash;]</span>&nbsp;
    <ng-container *ngFor="let user of authors">
      <a class="author" [routerLink]="['/tag', user]">
        {{ user.replace('+', '').replace('user/', '') }}
      </a>
    </ng-container>
    <span [title]="ref.created?.toISOString()">{{ ref.created?.fromNow() }}</span>
    <ng-container *ngIf="tagged.length">
      tagged
      <ng-container *ngFor="let tag of tagged">
        <a class="tag" [routerLink]="['/tag', tag]">{{ tag }}</a>&nbsp;
      </ng-container>
    </ng-container>
  </div>
  <div *ngIf="!editing"
       class="md comment-body"
       markdown
       [emoji]="emoji"
       [katex]="latex"
       [katexOptions]="{ throwOnError: false }"
       [data]="ref.comment"></div>
  <app-comment-edit *ngIf="editing"
                    [ref]="ref"
                    [commentEdited$]="commentEdited$"></app-comment-edit>
  <div class="actions">
    <a [routerLink]="['/ref', ref.url, 'comments']">permalink</a>
    <a [routerLink]="['/ref', ref.url, 'responses']">{{ responses.replace(' ', '&thinsp;') }}</a>
    <a [routerLink]="['/ref', ref.url, 'sources']">{{ sources.replace(' ', '&thinsp;')}}</a>
    <ng-container *ngIf="admin.status.plugins.graph">
      <a [routerLink]="['/ref', ref.url, 'graph']">graph</a>
    </ng-container>
    <a class="fake-link"
       *ngIf="writeAccess$ | async"
       (click)="editing = !editing">edit</a>
    <a class="fake-link"
       *ngIf="!deleting && (writeAccess$ | async)"
       (click)="deleting = true">delete</a>
    <span *ngIf="deleting" class="delete-confirm"> are you sure?
      <a class="fake-link" (click)="delete()">yes</a> /
      <a class="fake-link" (click)="deleting = false">no</a>
    </span>
    <a class="fake-link"
       *ngIf="writeAccess$ | async"
       (click)="tagging = !tagging">tag</a>
    <span *ngIf="tagging" class="inline-tagging">
      <input #inlineTag
             (keydown)="$event.key === 'Enter' && addInlineTag() || true"
             type="email"
             [pattern]="tagRegex"
             autocorrect="off"
             autocapitalize="none"
             appAutofocus>
      <button (click)="addInlineTag()">+</button>
    </span>
    <a class="fake-link"
       (click)="replying = !replying">reply</a>
    <ng-container *ngIf="canInvoice">
      <a [routerLink]="['/submit/invoice']"
         [queryParams]="{url: ref.url}">invoice</a>
    </ng-container>
    <a *ngIf="account.mod && !approved"
       class="fake-link"
       (click)="approve()">approve</a>
    <span class="approved icon" *ngIf="account.mod && approved">✔️</span>
  </div>
</div>
<app-comment-reply *ngIf="replying"
                   [autofocus]="true"
                   [top]="top"
                   [showCancel]="true"
                   [sources]="[ref.url]"
                   [tags]="inboxes"
                   [newComments$]="newComments$"></app-comment-reply>
<span class="fake-link load-more"
      *ngIf="!collapsed && context < maxContext && depth === 0 && ref.metadata!.plugins['plugin/comment'].length > 0"
      (click)="depth = depth + 1">
  load more comments
</span>
<a class="load-more"
   *ngIf="!collapsed && context >= maxContext && depth === 0 && ref.metadata!.plugins['plugin/comment'].length > 0"
   [routerLink]="['/ref', ref.url, 'comments']">
  continue this thread
</a>
<div *ngIf="depth! > 0"
     class="comment-children"
     [class.hidden-without-removing]="collapsed">
  <app-comment-list [top]="top"
                    [source]="ref.url"
                    [sort]="sort"
                    [depth]="depth! - 1"
                    [context]="context + 1"
                    [newComments$]="newComments$"></app-comment-list>
</div>

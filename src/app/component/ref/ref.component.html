<div class="link">
  <a *ngIf="webLink" [href]="ref.url">{{ ref.title || ref.url }}</a>
  <a *ngIf="!webLink && admin.status.plugins.comment" [routerLink]="['/ref', ref.url, 'comments']">{{ ref.title || ref.url }}</a>
  <a *ngIf="!webLink && !admin.status.plugins.comment" [routerLink]="['/ref', ref.url]">{{ ref.title || ref.url }}</a>
  <span class="host">({{ host }})</span>
</div>
<div class="link-below">
  <div class="toggle"
       *ngIf="showToggle && (ref.comment || expandPlugin) && !editing"
       (click)="expanded = !expanded">
    <span class="toggle-plus" *ngIf="!expanded">＋</span>
    <span class="toggle-x" *ngIf="expanded">✕</span>
  </div>
  <div class="stack">
    <div class="info">
      submitted {{ ref.created?.fromNow() }}
      <ng-container *ngIf="authors.length">
        by
        <ng-container *ngFor="let user of authors">
          <a [routerLink]="['/tag', user]">{{ user.replace('user/', '') + ref.origin }}</a>&nbsp;
        </ng-container>
      </ng-container>
      <ng-container *ngIf="tags.length">
        tagged
        <ng-container *ngFor="let tag of tags">
          <a [routerLink]="['/tag', tag]">{{ tag }}</a>&nbsp;
        </ng-container>
      </ng-container>
    </div>
    <div *ngIf="ref.comment && expanded && expandInline && !editing"
         class="md expand"
         markdown
         [emoji]="emoji"
         [katex]="latex"
         [katexOptions]="{ throwOnError: false }"
         [data]="ref.comment"></div>
    <div class="actions">
      <a *ngIf="admin.status.plugins.comment"
         [routerLink]="['/ref', ref.url, 'comments']">
        {{ comments.replace(' ', '&thinsp;') }}
      </a>
      <a [routerLink]="['/ref', ref.url, 'responses']">
        {{ responses.replace(' ', '&thinsp;') }}
      </a>
      <a [routerLink]="['/ref', ref.url, 'sources']">
        {{ sources.replace(' ', '&thinsp;') }}
      </a>
      <ng-container *ngIf="admin.status.plugins.graph">
        <a [routerLink]="['/ref', ref.url, 'graph']">graph</a>
      </ng-container>
      <a *ngIf="writeAccess$ | async"
         class="fake-link"
         (click)="editing = true">edit</a>
      <a *ngIf="!deleting && (writeAccess$ | async)"
         class="fake-link"
         (click)="deleting = true">delete</a>
      <span *ngIf="deleting" class="delete-confirm"> are you sure?
        <a class="fake-link" (click)="delete()">yes</a> /
        <a class="fake-link" (click)="deleting = false">no</a>
      </span>
      <a *ngIf="writeAccess$ | async"
         class="fake-link"
         (click)="tagging = !tagging">tag</a>
      <span *ngIf="tagging" class="inline-tagging">
        <input #inlineTag
               (keydown)="$event.key === 'Enter' && addInlineTag() || true"
               type="text"
               pattern="_?[a-z]+(/[a-z]+)*"
               appAutofocus>
        <button (click)="addInlineTag()">+</button>
      </span>
      <a *ngIf="account.mod && !approved"
         class="fake-link"
         (click)="approve()">approve</a>
      <span class="approved" *ngIf="account.mod && approved">✔️</span>
    </div>
  </div>
</div>
<div *ngIf="ref.comment && expanded && !expandInline && !editing"
     class="md expand"
     markdown
     [emoji]="emoji"
     [katex]="latex"
     [katexOptions]="{ throwOnError: false }"
     [data]="ref.comment"></div>

<form *ngIf="editing" class="form" [formGroup]="editForm" (ngSubmit)="save()">

  <label for="comment">Abstract:</label>
  <textarea id="comment" formControlName="comment"></textarea>

  <label for="sources">Sources:</label>
  <div id="sources" class="form-group" formArrayName="sources">
    <button type="button" (click)="addSource()">+ Add another source</button>

    <div *ngFor="let source of sourcesForm.controls; let i=index">
      <label for="sources-{{ i }}">Source:</label>
      <input id="sources-{{ i }}" type="text" [formControl]="$any(source)">
      <button type="button" (click)="removeSource(i)">&ndash;</button>
      <div class="error" *ngIf="sourcesForm.at(i).touched && sourcesForm.at(i).errors?.['required']">
        Source must not be blank.
      </div>
    </div>
  </div>

  <label for="tags">Tags:</label>
  <div id="tags" class="form-group" formArrayName="tags">
    <button type="button" (click)="addTag()">+ Add another tag</button>

    <div *ngFor="let tag of tagsForm.controls; let i=index">
      <label for="tags-{{ i }}">Tag:</label>
      <input id="tags-{{ i }}" type="text" [formControl]="$any(tag)">
      <button type="button" (click)="removeTag(i)">&ndash;</button>
      <div class="error" *ngIf="tagsForm.at(i).touched && tagsForm.at(i).errors?.['pattern']">
        Tags must be lower case letters and forward slashes. Must not start with a slash or contain two forward slashes in a row. Private
        tags start with an underscore.<br>
        (i.e. "science", "my/tag", or "_my/private/tag")
      </div>
      <div class="error" *ngIf="tagsForm.at(i).touched && tagsForm.at(i).errors?.['required']">
        Tag must not be blank.
      </div>
    </div>
  </div>

  <ng-container *ngFor="let e of serverError">
    <span><!-- Unexpected Error --></span>
    <div class="error">{{ e }}</div>
  </ng-container>

  <span><!-- Buttons --></span>
  <span class="form-group">
    <button type="submit" [disabled]="submitted && !editForm.valid">save</button>
    <button (click)="editing = false">cancel</button>
  </span>
</form>

